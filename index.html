<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Field Data Capture</title>

    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <style>
        /* ---------- BASIC LAYOUT ---------- */
        body {
            font-family: Arial, Helvetica, sans-serif;
            margin: 0;
            padding: 1rem;
            background: #f2f2f2;
            color: #333;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }
        h1 {
            text-align: center;
            color: #333;
            margin-top: 0.5rem;
            margin-bottom: 1.5rem;
        }

        form {
            background: #fff;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: grid;
            gap: 1rem;
            grid-template-columns: 1fr;
            max-width: 900px;
            margin: auto;
            margin-bottom: 2rem; /* Add space below form */
        }
        /* Adjust for smaller mobile screens before 600px breakpoint */
        @media (max-width: 599px) {
            form {
                padding: 0.8rem;
                gap: 0.8rem;
            }
            .field label {
                font-size: 0.95rem;
            }
            input, select, textarea {
                font-size: 0.9rem;
                padding: 0.4rem;
            }
            button {
                padding: 0.6rem 0.8rem;
                font-size: 0.9rem;
            }
        }
        @media (min-width: 600px) {
            form {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* ---------- FORM ELEMENTS ---------- */
        .field {
            display: flex;
            flex-direction: column;
        }
        label {
            margin-bottom: 0.3rem;
            font-weight: bold;
        }
        input, select, textarea {
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
            width: 100%; /* Ensure inputs take full width */
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }
        textarea {
            min-height: 50px;
            resize: vertical;
        }

        /* Style for readonly GPS inputs */
        input[readonly] {
            background-color: #e9e9e9;
            cursor: not-allowed;
        }

        /* ---------- BUTTONS ---------- */
        .actions {
            grid-column: 1 / -1;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-top: 1rem;
        }
        button {
            flex: 1 1 auto; /* Allow buttons to grow and shrink */
            min-width: 120px; /* Minimum width for buttons */
            border: none;
            border-radius: 5px;
            color: #fff;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
            box-shadow: none;
        }

        #gpsBtn { background: #28a745; } /* Green */
        #exportBtn { background: #ffc107; color: #000; } /* Amber/Yellow */
        #submitBtn { background: #007bff; } /* Blue */
        #syncBtn { background: #6c757d; } /* Grey */
        #viewDataBtn { background: #17a2b8; } /* Teal */
        #clearDataBtn { background: #dc3545; } /* Red */


        /* ---------- MESSAGES ---------- */
        #message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; /* Allow clicks to pass through */
            text-align: center;
            white-space: nowrap;
        }
        #message.show {
            opacity: 1;
        }

        /* ---------- SAVED DATA SECTION ---------- */
        #savedDataSection {
            background: #fff;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,.1);
            max-width: 900px;
            margin: auto;
            margin-top: 2rem;
            display: none; /* Hidden by default */
        }
        #savedDataSection.visible {
            display: block;
        }
        #savedDataSection h2 {
            text-align: center;
            color: #333;
            margin-top: 0;
            margin-bottom: 1rem;
        }
        #savedDataTableContainer {
            overflow-x: auto; /* Enable horizontal scrolling for tables on small screens */
            max-width: 100%; /* Ensure container respects parent width */
        }
        #savedDataTable {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        #savedDataTable th, #savedDataTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            white-space: nowrap; /* Prevent text wrapping in table cells */
        }
        #savedDataTable th {
            background-color: #f2f2f2;
            font-weight: bold;
            position: sticky; /* Make headers sticky for horizontal scroll */
            left: 0;
            z-index: 1;
        }
        #savedDataTable tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        #savedDataTable tr:hover {
            background-color: #f1f1f1;
        }
        #savedDataActions {
            text-align: center;
            margin-top: 1rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>

    <h1>Field Data Capture</h1>

    <form id="captureForm">
        <div class="field"><label for="workorderNo">Workorder No</label><input id="workorderNo" name="workorderNo" type="text" placeholder="Optional"></div>
        <div class="field"><label for="zone">Zone</label><input id="zone" name="zone" type="text" placeholder="e.g., North"></div>
        <div class="field"><label for="sector">Sector</label><input id="sector" name="sector" type="text" placeholder="e.g., A"></div>
        <div class="field"><label for="cnc">CNC</label><input id="cnc" name="cnc" type="text"></div>
        <div class="field"><label for="contractorName">Contractor Name or Source</label><input id="contractorName" name="contractorName" type="text"></div>
        <div class="field"><label for="date">Date</label><input id="date" type="date" name="date" required></div>
        <div class="field"><label for="feederName">Feeder Name</label><input id="feederName" name="feederName" type="text"></div>
        <div class="field"><label for="townshipName">Township Name</label><input id="townshipName" name="townshipName" type="text"></div>
        <div class="field"><label for="transformerNo">Transformer No <span style="color:red">*</span></label><input id="transformerNo" name="transformerNo" type="text" required></div>
        <div class="field"><label for="standNo">Stand No</label><input id="standNo" name="standNo" type="text"></div>
        <div class="field"><label for="installationNo">Installation No</label><input id="installationNo" name="installationNo" type="text"></div>
        <div class="field"><label for="latitude">Latitude (DD MM SS.SSS S/N)</label><input id="lat" name="latitude" type="text" readonly></div>
        <div class="field"><label for="longitude">Longitude (DD MM SS.SSS E/W)</label><input id="lon" name="longitude" type="text" readonly></div>

        <div class="field"><label for="access">Access</label><select id="access" name="access"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
        <div class="field"><label for="atHome">At Home</label><select id="atHome" name="atHome"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
        <div class="field"><label for="connected">Connected</label><select id="connected" name="connected"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
        <div class="field"><label for="abandoned">Abandoned</label><select id="abandoned" name="abandoned"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
        <div class="field"><label for="vandalised">Vandalised</label><select id="vandalised" name="vandalised"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
        <div class="field"><label for="illegal">Illegal</label><select id="illegal" name="illegal"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
        <div class="field"><label for="owner">Owner</label><select id="owner" name="owner"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>

        <div class="field"><label for="surname">Surname</label><input id="surname" name="surname" type="text"></div>
        <div class="field"><label for="name">Name</label><input id="name" name="name" type="text"></div>
        <div class="field"><label for="idNo">ID No</label><input id="idNo" name="idNo" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="e.g., 8501015000087"></div>
        <div class="field"><label for="phoneCode">Phone Code</label><input id="phoneCode" name="phoneCode" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="e.g., +27"></div>
        <div class="field"><label for="phoneNo">Phone No</label><input id="phoneNo" name="phoneNo" type="tel" inputmode="tel" placeholder="e.g., 821234567"></div>

        <div class="field"><label for="normalVendor">Normal Vendor</label><select id="normalVendor" name="normalVendor"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
        <div class="field"><label for="recentVendor">Most Recent Vendor</label><input id="recentVendor" name="recentVendor" type="text"></div>
        <div class="field"><label for="meterNo">Meter No</label><input id="meterNo" name="meterNo" type="text"></div>
        <div class="field"><label for="split">Split</label><select id="split" name="split"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
        <div class="field"><label for="commonBaseMeter">Common/Non Common Base Meter</label><input id="commonBaseMeter" name="commonBaseMeter" type="text"></div>
        <div class="field"><label for="edEcu">ED/ECU</label><input id="edEcu" name="edEcu" type="text"></div>
        <div class="field"><label for="meterType">Meter Type</label><input id="meterType" name="meterType" type="text"></div>
        <div class="field"><label for="tariffCode">Tariff Code</label><input id="tariffCode" name="tariffCode" type="text"></div>
        <div class="field"><label for="ampLimit">Amp Limit</label><input id="ampLimit" name="ampLimit" type="number" inputmode="numeric" pattern="[0-9]*"></div>
        <div class="field"><label for="supplyGroupCode">Supply Group Code</label><input id="supplyGroupCode" name="supplyGroupCode" type="text"></div>
        <div class="field"><label for="magCard">Mag Card/Keypad</label><input id="magCard" name="magCard" type="text"></div>
        <div class="field"><label for="stsOrProp">STS or Prop</label><input id="stsOrProp" name="stsOrProp" type="text"></div>

        <div class="field"><label for="tampered">Tampered</label><select id="tampered" name="tampered"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
        <div class="field"><label for="tamperMethod">Tamper Method</label><input id="tamperMethod" name="tamperMethod" type="text"></div>
        <div class="field"><label for="removed">Removed</label><select id="removed" name="removed"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
        <div class="field"><label for="tamperNotNo">Tamper Not No</label><input id="tamperNotNo" name="tamperNotNo" type="text"></div>

        <div class="field"><label for="cardTrip">Card Trip</label><select id="cardTrip" name="cardTrip"><option value="">— Select —</option><option value="Pass">Pass</option><option value="Fail">Fail</option></select></div>
        <div class="field"><label for="elTest">E/L Test</label><select id="elTest" name="elTest"><option value="">— Select —</option><option value="Pass">Pass</option><option value="Fail">Fail</option></select></div>
        <div class="field"><label for="meterFaulty">Meter Faulty</label><select id="meterFaulty" name="meterFaulty"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
        <div class="field"><label for="replaced">Replaced</label><select id="replaced" name="replaced"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
        <div class="field"><label for="mmfNo">MMF No</label><input id="mmfNo" name="mmfNo" type="text"></div>
        <div class="field"><label for="newMeterNo">New Meter No</label><input id="newMeterNo" name="newMeterNo" type="text"></div>
        <div class="field"><label for="newMeterType">New Meter Type</label><input id="newMeterType" name="newMeterType" type="text"></div>
        <div class="field"><label for="newMeterAmpLimit">New Meter Amp Limit</label><input id="newMeterAmpLimit" name="newMeterAmpLimit" type="number" inputmode="numeric" pattern="[0-9]*"></div>
        <div class="field"><label for="newMeterCardTrip">New Meter Card Trip</label><select id="newMeterCardTrip" name="newMeterCardTrip"><option value="">— Select —</option><option value="Pass">Pass</option><option value="Fail">Fail</option></select></div>
        <div class="field"><label for="newMeterElTest">New Meter E/L Test</label><select id="newMeterElTest" name="newMeterElTest"><option value="">— Select —</option><option value="Pass">Pass</option><option value="Fail">Fail</option></select></div>
        <div class="field"><label for="sealed">Sealed</label><select id="sealed" name="sealed"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
        <div class="field"><label for="sealNo">Seal No</label><input id="sealNo" name="sealNo" type="text"></div>
        <div class="field"><label for="remarks">Remarks</label><textarea id="remarks" name="remarks"></textarea></div>

        <div class="actions">
            <button type="button" id="gpsBtn">Get GPS</button>
            <button type="button" id="viewDataBtn">View Data</button>
            <button type="button" id="exportBtn">Download Excel</button>
            <button type="button" id="syncBtn">Sync Data (WIP)</button> <button type="submit" id="submitBtn">Save Data</button>
        </div>
    </form>

    <div id="message" role="alert" aria-live="polite"></div>

    <div id="savedDataSection">
        <h2>Saved Field Entries</h2>
        <div id="savedDataTableContainer">
            <table id="savedDataTable">
                <thead>
                    <tr id="savedTableHeader"></tr>
                </thead>
                <tbody id="savedTableBody"></tbody>
            </table>
        </div>
        <div id="savedDataActions">
            <button type="button" id="clearDataBtn">Clear All Saved Data</button>
            <button type="button" id="closeViewDataBtn">Close View</button>
        </div>
    </div>


    <script>
        const DB_NAME = 'FieldDataDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'records';

        let db;

        // Initialize IndexedDB
        function initDb() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };

                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.errorCode);
                    showMessage('Database error: ' + event.target.errorCode, 'error');
                    reject(event.target.error);
                };
            });
        }

        // Add a record to IndexedDB
        function addRecord(record) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.add(record);

                request.onsuccess = () => resolve();
                request.onerror = (event) => {
                    console.error('Add record error:', event.target.error);
                    showMessage('Error saving data.', 'error');
                    reject(event.target.error);
                };
            });
        }

        // Get all records from IndexedDB
        function getAllRecords() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();

                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => {
                    console.error('Get all records error:', event.target.error);
                    showMessage('Error retrieving data for export.', 'error');
                    reject(event.target.error);
                };
            });
        }

        // Clear all records from IndexedDB
        function clearAllRecords() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.clear();

                request.onsuccess = () => resolve();
                request.onerror = (event) => {
                    console.error('Clear records error:', event.target.error);
                    showMessage('Error clearing data.', 'error');
                    reject(event.target.error);
                };
            });
        }

        // --- UI Feedback Message ---
        const messageElement = document.getElementById('message');
        function showMessage(msg, type = 'info', duration = 3000) {
            messageElement.textContent = msg;
            messageElement.className = 'show'; // Reset classes
            if (type === 'error') {
                messageElement.style.backgroundColor = 'rgba(220, 53, 69, 0.8)'; // Red
            } else if (type === 'success') {
                messageElement.style.backgroundColor = 'rgba(40, 167, 69, 0.8)'; // Green
            } else {
                messageElement.style.backgroundColor = 'rgba(0, 0, 0, 0.7)'; // Default black
            }

            setTimeout(() => {
                messageElement.classList.remove('show');
            }, duration);
        }

        /* --- Decimal Degrees to DD MM SS.SSS with Hemisphere --- */
        function toDMS(dec, type) {
            const abs = Math.abs(dec);
            const deg = Math.floor(abs);
            const minF = (abs - deg) * 60;
            const min = Math.floor(minF);
            const sec = ((minF - min) * 60).toFixed(3); // Keep 3 decimal places for seconds

            let hemisphere = '';
            if (type === 'latitude') {
                hemisphere = dec >= 0 ? 'N' : 'S';
            } else if (type === 'longitude') {
                hemisphere = dec >= 0 ? 'E' : 'W';
            }

            // Pad degrees and minutes to two digits, seconds to 6 (including decimals)
            // Use String() explicitly for padding consistency
            return `${String(deg).padStart(2, '0')} ${String(min).padStart(2, '0')} ${sec.padStart(6, '0')} ${hemisphere}`;
        }

        /* --- Auto-GPS on load (mobile friendly) --- */
        window.addEventListener('load', () => {
            // Register Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => console.log('Service Worker Registered', registration))
                    .catch(error => console.error('Service Worker Registration Failed', error));
            }

            // Initialize DB and then get GPS
            initDb().then(() => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        pos => {
                            document.getElementById('lat').value = toDMS(pos.coords.latitude, 'latitude');
                            document.getElementById('lon').value = toDMS(pos.coords.longitude, 'longitude');
                            showMessage('Initial GPS acquired.', 'success', 2000);
                        },
                        err => {
                            console.warn('Auto GPS error:', err.message);
                            showMessage('Could not get initial GPS. Tap "Get GPS" if needed.', 'info', 4000);
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 } // Use cached position if available
                    );
                } else {
                    showMessage('Geolocation not supported by your browser.', 'error');
                }
            }).catch(e => {
                showMessage('Failed to initialize local database.', 'error');
            });

            // Set current date on load
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;
        });

        /* --- GPS BUTTON --- */
        document.getElementById('gpsBtn').onclick = () => {
            if (!navigator.geolocation) {
                showMessage('Geolocation not supported by your browser.', 'error');
                return;
            }
            showMessage('Getting GPS...', 'info', 5000);
            navigator.geolocation.getCurrentPosition(
                pos => {
                    document.getElementById('lat').value = toDMS(pos.coords.latitude, 'latitude');
                    document.getElementById('lon').value = toDMS(pos.coords.longitude, 'longitude');
                    showMessage('GPS acquired successfully!', 'success');
                },
                err => {
                    showMessage(`GPS Error: ${err.message}`, 'error');
                    console.error('GPS Error:', err);
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 } // Request fresh position
            );
        };

        /* --- FORM SUBMIT --- */
        document.getElementById('captureForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            // Transformer No validation
            if (!data.transformerNo.trim()) {
                showMessage('Transformer Number is mandatory.', 'error');
                document.getElementById('transformerNo').focus();
                return;
            }

            // Format date to YYYY/MM/DD
            if (data.date) {
                const d = new Date(data.date);
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                data.date = `${yyyy}/${mm}/${dd}`;
            }

            try {
                await addRecord(data);
                showMessage('Data saved successfully offline ✔', 'success');
                this.reset();
                // Re-set date and clear GPS after reset
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;
                document.getElementById('lat').value = '';
                document.getElementById('lon').value = '';
            } catch (error) {
                console.error('Failed to save record:', error);
                showMessage('Failed to save data.', 'error');
            }
        });

        /* --- EXCEL EXPORT --- */
        document.getElementById('exportBtn').addEventListener('click', async () => {
            let recordsToExport = [];
            try {
                recordsToExport = await getAllRecords();
            } catch (error) {
                console.error("Error fetching records for export:", error);
                showMessage('Could not retrieve data for export.', 'error');
                return;
            }

            if (recordsToExport.length === 0) {
                showMessage('No data to export.', 'info');
                return;
            }

            /* 1️⃣ Header mapping */
            const map = {
                workorderNo: "Workorder No", zone: "Zone", sector: "Sector", cnc: "CNC",
                contractorName: "Contractor Name", date: "Date", feederName: "Feeder Name",
                townshipName: "Township Name", transformerNo: "Transformer No", standNo: "Stand No",
                installationNo: "Installation No", latitude: "Latitude", longitude: "Longitude",
                access: "Access", atHome: "At Home", connected: "Connected", abandoned: "Abandoned",
                vandalised: "Vandalised", illegal: "Illegal", owner: "Owner", surname: "Surname",
                name: "Name", idNo: "ID No", phoneCode: "Phone Code", phoneNo: "Phone No",
                normalVendor: "Normal Vendor", recentVendor: "Most Recent Vendor", meterNo: "Meter No",
                split: "Split", commonBaseMeter: "Common/Non Common Base Meter", edEcu: "ED/ECU",
                meterType: "Meter Type", tariffCode: "Tariff Code", ampLimit: "Amp Limit",
                supplyGroupCode: "Supply Group Code", magCard: "Mag Card/Keypad", stsOrProp: "STS or Prop",
                tampered: "Tampered", tamperMethod: "Tamper Method", removed: "Removed",
                tamperNotNo: "Tamper Not No", cardTrip: "Card Trip", elTest: "E/L Test",
                meterFaulty: "Meter Faulty", replaced: "Replaced", mmfNo: "MMF No",
                newMeterNo: "New Meter No", newMeterType: "New Meter Type",
                newMeterAmpLimit: "New Meter Amp Limit", newMeterCardTrip: "New Meter Card Trip",
                newMeterElTest: "New Meter E/L Test", sealed: "Sealed", sealNo: "Seal No",
                remarks: "Remarks"
            };

            /* 2️⃣ Transform records */
            const formatted = recordsToExport.map(rec => {
                const obj = {};
                for (const k in rec) {
                    if (k !== 'id') { // Exclude the IndexedDB 'id' field
                        obj[map[k] || k] = rec[k];
                    }
                }
                return obj;
            });

            /* 3️⃣ Export */
            try {
                const ws = XLSX.utils.json_to_sheet(formatted);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'FieldData');
                XLSX.writeFile(wb, 'Field_Data.xlsx');
                showMessage('Data exported to Excel successfully!', 'success');
            } catch (error) {
                console.error('Error during Excel export:', error);
                showMessage('Error exporting data to Excel.', 'error');
            }
        });

        /* --- SYNC DATA (Placeholder) --- */
        document.getElementById('syncBtn').addEventListener('click', async () => {
            showMessage('Sync functionality is under development.', 'info', 3000);
            // In a real application, you would:
            // 1. Get all records from IndexedDB.
            // 2. Filter for unsynced records (you'd need a 'synced' flag in your data).
            // 3. Send records to a backend server.
            // 4. On successful sync, update the 'synced' flag in IndexedDB.
            // 5. Handle network errors and retry logic.
            // Example:
            /*
            try {
                const allRecords = await getAllRecords();
                const unsyncedRecords = allRecords.filter(rec => !rec.synced); // Requires a 'synced' field
                if (unsyncedRecords.length === 0) {
                    showMessage('No new data to sync.', 'info');
                    return;
                }
                showMessage('Attempting to sync data...', 'info', 5000);
                // Replace with your actual API endpoint and fetch logic
                const response = await fetch('/api/sync-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(unsyncedRecords)
                });
                if (response.ok) {
                    // Mark records as synced in IndexedDB
                    // You'd need a function to update records
                    showMessage('Data synced successfully!', 'success');
                } else {
                    showMessage('Sync failed. Please try again later.', 'error');
                }
            } catch (error) {
                console.error('Sync error:', error);
                showMessage('Network error during sync.', 'error');
            }
            */
        });

        /* --- VIEW SAVED DATA --- */
        const savedDataSection = document.getElementById('savedDataSection');
        const savedTableHeader = document.getElementById('savedTableHeader');
        const savedTableBody = document.getElementById('savedTableBody');

        document.getElementById('viewDataBtn').addEventListener('click', async () => {
            if (savedDataSection.classList.contains('visible')) {
                // If already visible, close it
                savedDataSection.classList.remove('visible');
                showMessage('Data view closed.', 'info', 2000);
                return;
            }

            try {
                const records = await getAllRecords();
                if (records.length === 0) {
                    showMessage('No saved data to display.', 'info');
                    return;
                }

                // Get all possible headers from all records
                const allKeys = new Set();
                records.forEach(record => {
                    Object.keys(record).forEach(key => {
                        if (key !== 'id') { // Exclude IndexedDB internal 'id'
                            allKeys.add(key);
                        }
                    });
                });
                const headers = Array.from(allKeys).sort(); // Sort headers alphabetically

                // Clear previous table content
                savedTableHeader.innerHTML = '';
                savedTableBody.innerHTML = '';

                // Create table header row
                headers.forEach(key => {
                    const th = document.createElement('th');
                    // Human-readable header names (optional, could use a more comprehensive map)
                    th.textContent = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    savedTableHeader.appendChild(th);
                });

                // Populate table body
                records.forEach(record => {
                    const tr = document.createElement('tr');
                    headers.forEach(key => {
                        const td = document.createElement('td');
                        td.textContent = record[key] || ''; // Display value or empty string if not present
                        tr.appendChild(td);
                    });
                    savedTableBody.appendChild(tr);
                });

                savedDataSection.classList.add('visible');
                showMessage('Displaying saved data.', 'success', 2000);

            } catch (error) {
                console.error('Error displaying saved data:', error);
                showMessage('Failed to load saved data.', 'error');
            }
        });

        document.getElementById('closeViewDataBtn').addEventListener('click', () => {
            savedDataSection.classList.remove('visible');
            showMessage('Data view closed.', 'info', 2000);
        });

        /* --- CLEAR ALL SAVED DATA --- */
        document.getElementById('clearDataBtn').addEventListener('click', async () => {
            if (confirm('Are you sure you want to clear ALL saved data? This cannot be undone.')) {
                try {
                    await clearAllRecords();
                    savedTableBody.innerHTML = ''; // Clear table display
                    savedTableHeader.innerHTML = ''; // Clear table headers
                    savedDataSection.classList.remove('visible'); // Hide the section
                    showMessage('All saved data cleared successfully!', 'success');
                } catch (error) {
                    console.error('Error clearing data:', error);
                    showMessage('Failed to clear all data.', 'error');
                }
            }
        });
    </script>
</body>
</html>